flowchart LR
    Players[Players / Clients]

    %% User Management
    subgraph UserManagement["User Management Service"]
        UDB[(Users DB)]
        UM[Users]
    end

    %% Ghost AI
    subgraph GhostAI["Ghost AI Service"]
        GA[Ghost AI]
    end

    %% Shop
    subgraph ShopService["Shop Service"]
        SDB[(Items DB)]
        SHOP[Shop]
    end

    %% Journal
    subgraph JournalService["Journal Service"]
        JDB[(Journals DB)]
        JRNL[Journal]
    end

    %% Lobby
    subgraph LobbyService["Lobby Service"]
        LDB[(Lobby DB)]
        LOBBY[Lobby]
    end

    %% Map
    subgraph MapService["Map Service"]
        MDB[(Maps DB)]
        MAP[Map]
    end

    %% Ghost Encyclopedia
    subgraph GhostService["Ghost Service"]
        GDB[(Ghost Types DB)]
        GHOST[Ghost]
    end

    %% Location Tracking
    subgraph LocationService["Location Service"]
        LOCDB[(Location DB)]
        LOC[Location]
    end

    %% --- Players direct sync APIs ---
    Players -- "POST /users/register, login" --> UM:::sync
    Players -- "GET /items, POST /items" --> SHOP:::sync
    Players -- "POST /journals, GET /journals" --> JRNL:::sync
    Players -- "POST /lobbies, GET /lobbies" --> LOBBY:::sync
    Players -- "GET /maps, POST /maps" --> MAP:::sync
    Players -- "GET /ghosts, POST /ghosts" --> GHOST:::sync
    Players -- "POST /location/track, GET latest" --> LOC:::sync

    %% --- Cross-service interactions ---
    LOBBY -- "POST /ghostai/lobbies/{id}/spawn" --> GA:::sync
    GA -- "events: haunting, movement" --> LOBBY:::async

    LOBBY -- "GET /users/{id}" --> UM:::sync
    LOBBY -- "GET /maps/{id}" --> MAP:::sync

    JRNL -- "GET /users/{id}" --> UM:::sync
    JRNL -- "GET /lobbies/{id}" --> LOBBY:::sync

    GA -- "events: player positions" --> LOC:::async
    LOC -- "stream: location updates" --> GA:::async

    GA -- "GET /ghosts/{id}" --> GHOST:::sync

    %% Legend styles
    classDef sync stroke:#2c7be5,stroke-width:2px,color:#2c7be5;
    classDef async stroke:#e67e22,stroke-dasharray: 5 5,stroke-width:2px,color:#e67e22;
